package com.jdbc;

import java.io.*;
import java.net.*;
import java.sql.*;
import java.util.Scanner;
import java.util.ArrayList;



import com.jdbc.user.getQuestions;
import com.jdbc.user.player;

public class GameServerTest_2 {
    private static final int PORT = 8080;
    private static final int MAX_PLAYERS = 1; // controls how many clients to connect to play.
    S
    private static ArrayList<ClientHandler2> clients = new ArrayList<>(); // adds clients to a list.
    
   // private CountDownLatch gameStartLatch = new CountDownLatch(MAX_PLAYERS); // used to ensure everyone is ready to begin game.

    public static void main(String[] args) throws Exception{
    	
    	String[][] questions = getQuestions.questionList();
    	
        try (ServerSocket serverSocket = new ServerSocket(PORT)) {
            System.out.println("Server started on port " + PORT);

            while (true) {
            
                Socket clientSocket = serverSocket.accept();
                System.out.println("New client connected: " + clientSocket.getInetAddress());
                // Create a new client handler for each connected client
                ClientHandler2 clientHandler = new ClientHandler2(clientSocket, questions);
                clients.add(clientHandler);
                new Thread(clientHandler).start();
                
             // Check if enough players have connected to start the game
                if (clients.size() >= MAX_PLAYERS) {
                	System.out.println("Player connected.");
                    startGame(new BufferedReader(new InputStreamReader(clientSocket.getInputStream())), new PrintWriter(clientSocket.getOutputStream(),true), questions, clients);
                    break; // Exit the loop after starting the game
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    private static void startGame(BufferedReader in, PrintWriter out, String[][] questions, ArrayList<ClientHandler2> list) throws IOException, SQLException, Exception {
    	Scanner user = new Scanner(System.in);
		Scanner start = new Scanner(System.in);
		
		
		
		player p = new player();
		
		//only question is how to give points to individual players
		//can do an array list then keep track of each player when assigning points
		//then do a loop at the end of the game to put into database
		
		
		//Sample Questions
		//setup {question, answer1, answer2, answer3, answer4, correct answer}
		
		//String[][] questions = getQuestions.questionList();
		for (int i = 0; i < questions.length; i++) {
		    // Iterate over each column in the current row
		    for (int j = 0; j < questions[i].length; j++) {
		        // Access the element at row i and column j
		        String element = questions[i][j];
		        System.out.print(element + " "); // Print the element
		    }
		    System.out.println(); // Move to the next line after each row
		}
		
		System.out.println("Type \"Start\" to start game: ");
		String s = start.next();
		
		for(int i = 0; i < 10; i++) { // the amount of questions in the game
			
			int rq = getQuestions.getRandomQuestion(questions);
			
			out.println("Question " + (i+1) + ": " + questions[i][0]);
			
			out.println("Answers: \r1. " + questions[i][1] + "\r2. " + questions[i][2] + "\r3. " + questions[i][3] + "\r4. " + questions[i][4]);
			
			out.println("Your Answer: ");
			
			
			//can put a while that waits for all users to have answered or if time runs out
			
			int userInput = Integer.parseInt(in.readLine());
			
	        if(userInput == Integer.parseInt(questions[i][5])) {
	        	out.println("You're Correct");
	        	
	        	p.setCorrect(1 + p.getCorrect());
	        	p.setScore(100 + p.getScore());
	        }
	        else {
	        	out.println("You're Answer was Wrong");
	        }
	        
	        
		
	        System.out.println("Enter \"ok\" to continue: ");
	        String wait = user.next();
	        
		}//for
		user.close();
		start.close();
		
		out.println("Players Score: " + p.getScore());
		out.println("Players Correct Answers: " + p.getCorrect());
    }
		
	}



class ClientHandler2 implements Runnable {
    private Socket clientSocket;
    private Connection connection;
    private String loggedInUser;
    public String[][] questions;
    BufferedReader in;
    PrintWriter out;

    public ClientHandler2(Socket clientSocket , String[][] questions) throws IOException {
    	
    	in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
        out = new PrintWriter(clientSocket.getOutputStream(), true);
        this.clientSocket = clientSocket;
        this.questions = questions;
        }

    @Override
    public void run(){
        try 
            // Input and output streams for communication with the client
            
         {
            // Send a welcome message to the client
            out.println("Welcome to Trivia Game.");
            out.flush();
            sendGameMenu(out);

            // Process the client's input
            processClientInput(in, out);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            closeResources();
        }
    }
    
    public void notifyGameStart(PrintWriter out) {
        out.println("Game is starting. Get ready!");
        //gameStartLatch.countDown(); // Signal readiness to start the game
    }
    
   
    
    // Display the game menu to the client
    private void sendGameMenu(PrintWriter out) {
        // Game menu
        out.println("Trivia Game");
        out.println("1. Log-In");
        out.println("2. Create Account");
        out.println("3. Leaderboards (WIP)");
        out.println("4. Play Game (WIP)");
        out.println("9. Log-Out");
        out.println("Please choose an option by typing the corresponding number.");
        out.flush();
    }
    
 // Display the game menu to the client
    private void sendPlayGameMenu(PrintWriter out) {
        // Game menu
        out.println("Play Game Menu");
        out.println("1. Create Lobby");
        out.println("2. Join Lobby");
        out.println("3. Play Game");
        out.println("9. Return the main menu");
        out.println("Please choose an option by typing the corresponding number.");
        out.flush();
    }

    // A simple method to demonstrate the game starting for the client
    private void processClientInput(BufferedReader in, PrintWriter out) throws IOException, SQLException, Exception {
        while (true) {
            // Read client input
            String clientInput = in.readLine();
            System.out.println("Client " + clientSocket.getInetAddress() + " selected option " + clientInput + ".");

            if (clientInput == null) {
                break; // Client disconnected
            }

            int choice;
            try {
                choice = Integer.parseInt(clientInput);
            } catch (NumberFormatException e) {
                out.println("Invalid choice, please try again.");
                continue;
            }

            // Switch-case to handle user input choice
            switch (choice) {
                case 1:
                    Login(in, out);
                    break;
                case 2:
                    createAccount(in, out);
                    break;
                /*
                case 3:
                    leaderboards(in, out);
                    break;
				*/
                case 4:    
                    playGame(in, out);
                    break;
                case 9:
                	out.println("Logging " + loggedInUser + " out.");
                	loggedInUser = null;
                default:
                    out.println("Invalid choice, please try again.");
                    break;
            }
            out.flush();
            // Return to game menu
            sendGameMenu(out);
        }
    }
    
    private void playGame(BufferedReader in, PrintWriter out) throws SQLException, IOException, Exception {
        sendPlayGameMenu(out);
        while (true) {
            // Read client input
            String clientInput = in.readLine();
            System.out.println("Client " + clientSocket.getInetAddress() + " selected option " + clientInput + ".");

            if (clientInput == null) {
                break; // Client disconnected
            }

            int choice;
            try {
                choice = Integer.parseInt(clientInput);
            } catch (NumberFormatException e) {
                out.println("Invalid choice, please try again.");
                continue;
            }

            // Switch-case to handle user input choice
            switch (choice) {
                case 1:
                    createLobby(in, out);
                    break;
                case 2:
                    joinLobby(in, out);
                    break;
                case 3:
                	startGame();
                	return;
                case 9:
                	return;
                default:
                    out.println("Invalid choice, please try again.");
                    break;
            }
            out.flush();
            // Return to game menu
            sendPlayGameMenu(out);
        }
    }

    private void createLobby(BufferedReader in, PrintWriter out) throws IOException, SQLException {
        
    	out.println("Create a lobby:");
    	out.flush();
    	
    	//Get information from client in creating lobby
    	out.println("Name of the lobby: ");
    	out.flush();
    	String lobbyName = in.readLine();
    	System.out.println(clientSocket.getInetAddress() + " created a new lobby named \"" + lobbyName + "\".");
    	
    	out.println("Enter max players able to join lobby: ");
    	out.flush();
    	int maxPlayers = Integer.parseInt(in.readLine());
    	System.out.println(clientSocket.getInetAddress() + " set max players in \" " + lobbyName + "\" to " + maxPlayers + ".");
    	out.flush();
    	
    	// Inserting data in database
        String sql = "INSERT INTO lobbies (name, max_players, current_players) VALUES (?, ?, ?)";
        
        int currentPlayers = 1;
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            preparedStatement.setString(1, lobbyName);
            preparedStatement.setInt(2,maxPlayers);
            preparedStatement.setInt(3, currentPlayers);
            
            int rowsAffected = preparedStatement.executeUpdate();

            // Inform the client if the account creation was successful
            if (rowsAffected > 0) {
                out.println(lobbyName + " created successfully.\n");
            } 
            else {
                out.println("Failed to create lobby.\n");
            }
            out.flush();
        }  	
    }

    private void joinLobby(BufferedReader in, PrintWriter out) throws IOException, SQLException {
        // Query the database to retrieve all available lobbies
        String sql = "SELECT name, current_players, max_players FROM lobbies";
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            try (ResultSet resultSet = preparedStatement.executeQuery()) {
                // Display available lobbies to the client with an index
                out.println("Available Lobbies:");
                int index = 1;
                while (resultSet.next()) {
                    String name = resultSet.getString("name");
                    int currentPlayers = resultSet.getInt("current_players");
                    int maxPlayers = resultSet.getInt("max_players");
                    out.println(index + ". " + name + " (" + currentPlayers + "/" + maxPlayers + ") players");
                    index++;
                }
                out.println("Choose a lobby to join (enter the corresponding number):");
                out.flush();
                
                // Read client input to select a lobby
                String input = in.readLine();
                int lobbyChoice = Integer.parseInt(input);
                
                // Process the lobby choice
                if (lobbyChoice >= 1 && lobbyChoice < index) {
                    // Get the selected lobby name based on the index
                    resultSet.absolute(lobbyChoice);
                    String selectedLobbyName = resultSet.getString("name");
                    
                    // Update the database to reflect the new player joining
                    sql = "UPDATE lobbies SET current_players = current_players + 1 WHERE name = ?";
                    try (PreparedStatement updateStatement = connection.prepareStatement(sql)) {
                        updateStatement.setString(1, selectedLobbyName);
                        int rowsUpdated = updateStatement.executeUpdate();
                        if (rowsUpdated > 0) {
                            out.println("You joined " + selectedLobbyName + ". Waiting for other players...\n");
                        } else {
                            out.println("Failed to join the lobby. Please try again.\n");
                        }
                    }
                } else {
                    out.println("Invalid lobby choice. Please enter a valid number.\n");
                }
            }
        }
    }



    
    private void createAccount(BufferedReader in, PrintWriter out) throws SQLException, IOException {
        out.println("Creating Account");
        out.flush();

        // Getting username, email, and password from user
        // Username
        out.println("Enter username: ");
        out.flush();
        String username = in.readLine();
        System.out.println("Client " + clientSocket.getInetAddress() + " entered username: " + username + ".");
        
        out.println("Username entered successfully.");
        out.println("Enter email: ");
        out.flush();
        String email = in.readLine();
        System.out.println("Client " + clientSocket.getInetAddress() + " entered email: " + email + ".");
        
        out.println("Email entered successfully.");
        out.println("Enter password: ");
        out.flush();
        String password = in.readLine();
        System.out.println("Client " + clientSocket.getInetAddress() + " entered password: " + password + ".");
        
        out.println("Password entered successfully.");
        out.println("Account created successfully.");
        out.flush();
        
        

        // Inserting data in database
        String sql = "INSERT INTO players(username, email, password) VALUES (?, ?, ?)";
        
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            preparedStatement.setString(1, username);
            preparedStatement.setString(2, email);
            preparedStatement.setString(3, password);
            
            int rowsAffected = preparedStatement.executeUpdate();

            // Inform the client if the account creation was successful
            if (rowsAffected > 0) {
                out.println("Account created successfully for " + username + ".\n");
            } 
            else {
                out.println("Failed to create account.\n");
            }
            out.flush();
        }
    }

    private void Login(BufferedReader in, PrintWriter out) throws SQLException, IOException {
        out.println("Log-In");
        out.flush();

        // Get email and password from client
        out.println("Enter email: ");
        out.flush();
        String email = in.readLine();
        if (email != null) {
        	System.out.println(clientSocket.getInetAddress() + " entered email successfully.");
        }
        else {
        	System.out.println(clientSocket.getInetAddress() + " failed to receive email.");
        }
        out.flush();

        out.println("Enter password: ");
        out.flush();
        String password = in.readLine();
        if (password != null) {
        	System.out.println(clientSocket.getInetAddress() + " entered password successfully.");
        }
        else {
        	System.out.println(clientSocket.getInetAddress() + " failed to receive password.");
        }
        out.flush();

        // Verification of email and password
        String sql = "SELECT username, password FROM players WHERE email = ?";
        
        try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
            preparedStatement.setString(1, email);

            try (ResultSet resultSet = preparedStatement.executeQuery()) {
                if (resultSet.next()) {
                    String DBpassword = resultSet.getString("password");
                    String username = resultSet.getString("username");

                    if (DBpassword.equals(password)) {
                        out.println("Login successful. Welcome back " + username + ".\n");
                        loggedInUser = username;
                    } 
                    else {
                        out.println("Invalid email or password, try again.\n");
                    }
                } 
                else {
                    out.println("Email does not exist.\n");
                }
                out.flush();
            }
        }
    }

    private void closeResources() {
        try {
            if (connection != null) {
                connection.close();
            }
            clientSocket.close();
        } catch (IOException | SQLException e) {
            e.printStackTrace();
        }
    }
}
